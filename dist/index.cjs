"use strict";var e=require("@actions/core"),t=require("child_process"),n=require("fs/promises"),r=require("path"),o=require("axios"),a=require("axios-retry"),u=require("form-data"),s=require("handlebars"),i=require("sharp");function c(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var l=c(e);function p(e,t,n,r){return new(n||(n=Promise))((function(o,a){function u(e){try{i(r.next(e))}catch(e){a(e)}}function s(e){try{i(r.throw(e))}catch(e){a(e)}}function i(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(u,s)}i((r=r.apply(e,t||[])).next())}))}function f(e,t){var n,r,o,a,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(s){return function(i){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;a&&(a=0,s[0]&&(u=0)),u;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return u.label++,{value:s[1],done:!1};case 5:u.label++,r=s[1],s=[0];continue;case 7:s=u.ops.pop(),u.trys.pop();continue;default:if(!(o=u.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){u=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){u.label=s[1];break}if(6===s[0]&&u.label<o[1]){u.label=o[1],o=s;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(s);break}o[2]&&u.ops.pop(),u.trys.pop();continue}s=t.call(e,u)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,i])}}}var g=o.create();a(g,{retries:2,retryDelay:a.exponentialDelay,retryCondition:function(e){return"ECONNABORTED"!==e.code&&(!e.response||e.response.status>=400&&e.response.status<=599)},onRetry:function(e,t){var n;console.log("Retrying request to ".concat(null===(n=t.config)||void 0===n?void 0:n.url))}});function d(){return p(this,void 0,void 0,(function(){var e,t,o,a,c,d,h,b,m,y,v,_,w,q,O;return f(this,(function(j){switch(j.label){case 0:return e=r.join(__dirname,"..","static","views","release-flag-template.hbs"),t=JSON.parse(l.getInput("repo_github_object")),o=+l.getInput("flag-quality"),a=t.event.repository,c=a.name,d=a.contributors_url,h=a.pulls_url,b=a.stargazers_count,m=a.open_issues_count,[4,g.get(d)];case 1:return y=j.sent().data,v=y.length,[4,g.get(h.replace(/{.*}/,""))];case 2:return _=j.sent().data,w=_.filter((function(e){return"open"===e.state})).length,q={repoName:c.toUpperCase().replace(/-/g," "),version:l.getInput("version"),prerelease:"true"===l.getInput("prerelease"),startsCount:+b,openIssuesCount:+m,contributorsCount:v,openPRsCount:w},O=r.join(__dirname,"release.jpg"),l.setOutput("output_flag_path",O),function(e,t){return n.readFile(e,{encoding:"utf-8"}).then((function(e){return s.compile(e)(t)}))}(e,q).then((function(e){return function(e,t){return void 0===t&&(t=150),i(Buffer.from(e,"utf-8"),{density:t}).toBuffer()}(e,o)})).then((function(e){!function(e){p(this,void 0,void 0,(function(){var t,n,r,o,a,s;return f(this,(function(i){return t=l.getInput("telegram_to"),n=l.getInput("telegram_token"),r=l.getInput("telegram_message"),o=l.getInput("telegram_message_format"),a="https://api.telegram.org/bot".concat(n,"/sendPhoto"),(s=new u).append("chat_id",t),s.append("photo",e,{filename:"image.jpeg"}),s.append("caption",r),s.append("parse_mode",o),[2,g.post(a,s).then((function(e){console.log("Telegram message response status code: ".concat(e.status)),console.log(e.data.ok?"Telegram message sent successfully":"Sending telegram message failed!")}))]}))}))}(e),l.setOutput("output_flag_buf",e),n.writeFile(O,e)})),[2]}}))}))}t.exec("bash static/install_fonts.sh",(function(e,t,n){e?console.error("fonts install script error: ".concat(e)):(t&&console.log("stdout: ".concat(t)),n&&console.error("stderr: ".concat(n)),d())}));